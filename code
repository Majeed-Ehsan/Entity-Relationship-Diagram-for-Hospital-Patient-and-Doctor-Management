-- Hospital Management ERD -> SQL DDL (MySQL)
-- Tables only (no INSERTs). Based on your ERD: Hospital, DeptType, Dept, Doctor, Patient,
-- relationships Work (Doctor_Dept), Treat (Doctor_Patient), and Admission (Dept -> Patient).

-- Drop existing objects (safe for repeated runs)
SET FOREIGN_KEY_CHECKS = 0;
DROP TABLE IF EXISTS Doctor_Patient;
DROP TABLE IF EXISTS Doctor_Dept;
DROP TABLE IF EXISTS Admission;
DROP TABLE IF EXISTS Patient;
DROP TABLE IF EXISTS Doctor;
DROP TABLE IF EXISTS Dept;
DROP TABLE IF EXISTS DeptType;
DROP TABLE IF EXISTS Hospital;
SET FOREIGN_KEY_CHECKS = 1;

-- 1) Hospital
CREATE TABLE Hospital (
  hospital_id INT AUTO_INCREMENT PRIMARY KEY,
  reg_no VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(200) NOT NULL,
  email VARCHAR(200),
  street VARCHAR(200),
  city VARCHAR(100),
  province VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- 2) Department Type (lookup for Dept Type: ED, ICU, OR, IPD, Special Wards ...)
CREATE TABLE DeptType (
  type_id INT AUTO_INCREMENT PRIMARY KEY,
  type_name VARCHAR(100) NOT NULL UNIQUE
) ENGINE=InnoDB;

-- 3) Department
CREATE TABLE Dept (
  dept_id INT AUTO_INCREMENT PRIMARY KEY,
  hospital_id INT NOT NULL,
  dept_name VARCHAR(150) NOT NULL,
  dept_id_external VARCHAR(50),
  staff_count INT DEFAULT 0,
  internal_phone VARCHAR(50),
  doctor_head INT, -- will reference Doctor.doctor_id (added after Doctor table)
  location VARCHAR(200),
  type_id INT, -- FK to DeptType
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_dept_hospital FOREIGN KEY (hospital_id) REFERENCES Hospital(hospital_id) ON DELETE CASCADE,
  CONSTRAINT fk_dept_type FOREIGN KEY (type_id) REFERENCES DeptType(type_id) ON DELETE SET NULL
) ENGINE=InnoDB;

-- 4) Doctor
CREATE TABLE Doctor (
  doctor_id INT AUTO_INCREMENT PRIMARY KEY,
  doctor_code VARCHAR(50) UNIQUE,
  first_name VARCHAR(100) NOT NULL,
  last_name VARCHAR(100),
  phone VARCHAR(50),
  date_of_birth DATE,
  specialization VARCHAR(200),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- Add fk for dept.doctor_head referencing Doctor
ALTER TABLE Dept
  ADD CONSTRAINT fk_dept_doctor_head FOREIGN KEY (doctor_head) REFERENCES Doctor(doctor_id) ON DELETE SET NULL;

-- 5) Patient
CREATE TABLE Patient (
  patient_id INT AUTO_INCREMENT PRIMARY KEY,
  mr_no VARCHAR(50) UNIQUE NOT NULL,
  first_name VARCHAR(100) NOT NULL,
  last_name VARCHAR(100),
  gender ENUM('Male','Female','Other') DEFAULT 'Male',
  blood_type VARCHAR(5),
  date_of_birth DATE,
  phone VARCHAR(50),
  permanent_address VARCHAR(300),
  current_address VARCHAR(300),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- 6) Admission (models Dept -> Patient admitted relationship)
CREATE TABLE Admission (
  admission_id INT AUTO_INCREMENT PRIMARY KEY,
  patient_id INT NOT NULL,
  dept_id INT NOT NULL,
  admit_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  discharge_date DATETIME NULL,
  reason VARCHAR(500),
  CONSTRAINT fk_adm_patient FOREIGN KEY (patient_id) REFERENCES Patient(patient_id) ON DELETE CASCADE,
  CONSTRAINT fk_adm_dept FOREIGN KEY (dept_id) REFERENCES Dept(dept_id) ON DELETE CASCADE,
  UNIQUE (patient_id, admit_date)
) ENGINE=InnoDB;

-- 7) Doctor_Dept (Work: many-to-many between Doctor and Dept)
CREATE TABLE Doctor_Dept (
  doctor_id INT NOT NULL,
  dept_id INT NOT NULL,
  start_date DATE,
  end_date DATE,
  role VARCHAR(100),
  PRIMARY KEY (doctor_id, dept_id),
  CONSTRAINT fk_dd_doctor FOREIGN KEY (doctor_id) REFERENCES Doctor(doctor_id) ON DELETE CASCADE,
  CONSTRAINT fk_dd_dept FOREIGN KEY (dept_id) REFERENCES Dept(dept_id) ON DELETE CASCADE
) ENGINE=InnoDB;

-- 8) Doctor_Patient (Treat: many-to-many between Doctor and Patient)
CREATE TABLE Doctor_Patient (
  doctor_id INT NOT NULL,
  patient_id INT NOT NULL,
  treat_date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  notes TEXT,
  PRIMARY KEY (doctor_id, patient_id, treat_date),
  CONSTRAINT fk_dp_doctor FOREIGN KEY (doctor_id) REFERENCES Doctor(doctor_id) ON DELETE CASCADE,
  CONSTRAINT fk_dp_patient FOREIGN KEY (patient_id) REFERENCES Patient(patient_id) ON DELETE CASCADE
) ENGINE=InnoDB;

-- Indexes to improve lookups
CREATE INDEX idx_dept_hospital ON Dept(hospital_id);
CREATE INDEX idx_adm_patient ON Admission(patient_id);
CREATE INDEX idx_adm_dept ON Admission(dept_id);
